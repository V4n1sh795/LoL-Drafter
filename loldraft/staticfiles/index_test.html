<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–í—ã–±–æ—Ä —á–µ–º–ø–∏–æ–Ω–∞</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background-color: #f5f5f5;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 20px;
    }

    #timer {
      text-align: center;
      font-size: 24px;
      font-weight: bold;
      color: #d32f2f;
      margin-bottom: 20px;
      padding: 10px;
      background-color: #ffebee;
      border-radius: 8px;
    }

    #champions-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
      justify-content: center;
    }

    .champion-cell {
      width: 80px;
      height: 80px;
      border: 2px solid #ccc;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #f9f9f9;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.2s;
      font-size: 12px;
      text-align: center;
      padding: 5px;
    }

    .champion-cell.selected {
      border-color: #007bff;
      background-color: #e7f3ff;
      transform: scale(1.05);
    }

    .buttons-container {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-bottom: 20px;
    }

    .btn {
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    #confirm-btn {
      background-color: #007bff;
      color: white;
    }

    #confirm-btn:hover {
      background-color: #0056b3;
    }

    #ban-btn {
      background-color: #dc3545;
      color: white;
    }

    #ban-btn:hover {
      background-color: #c82333;
    }

    #result {
      margin-top: 15px;
      font-size: 18px;
      font-weight: bold;
      color: #333;
      text-align: center;
      min-height: 24px;
    }

    .time-expired {
      background-color: #ffcdd2 !important;
      color: #b71c1c !important;
    }
  </style>
</head>
<body>

  <div class="container">
    <h1>–í—ã–±–µ—Ä–∏—Ç–µ —á–µ–º–ø–∏–æ–Ω–∞</h1>
    
    <div id="timer">–í—Ä–µ–º—è: 30 —Å–µ–∫—É–Ω–¥</div>

    <div id="champions-container">
      <!-- –Ø—á–µ–π–∫–∏ –±—É–¥—É—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã —Å—é–¥–∞ -->
    </div>

    <div class="buttons-container">
      <button id="confirm-btn" class="btn">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
    </div>
    
    <div id="result"></div>
  </div>

  <script>
  const champions = ["–ê—Ä–∏", "–ë—Ä–∞—É–º", "–í–∏–∫—Ç–æ—Ä", "–ì–∞–ª–∏–æ", "–î–∞—Ä–∏—É—Å", "–Å–Ω–µ", "–ñ–∞–Ω–Ω–∞", "–≠–ª–∏–∑–∞", "–ö—Å–∏–Ω", "–û—Ä–∏–∞–Ω–Ω–∞"];
  const roomID = window.location.pathname.split('/')[2];
  const container = document.getElementById("champions-container");
  const timerElement = document.getElementById("timer");
  let selectedCell = null;
  let timeLeft = 30;
  let timerInterval = null;

  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —è—á–µ–µ–∫ —á–µ–º–ø–∏–æ–Ω–æ–≤
  champions.forEach(name => {
    const cell = document.createElement("div");
    cell.classList.add("champion-cell");
    cell.textContent = name;
    cell.addEventListener("click", () => {
      if (selectedCell) selectedCell.classList.remove("selected");
      cell.classList.add("selected");
      selectedCell = cell;
    });
    container.appendChild(cell);
  });

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  async function SendChoice(champName) {
    try {
      const response = await fetch(`/room/${roomID}/action/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ 
          user_uid: localStorage.getItem('user_uid'), 
          champName: champName 
        })
      });
      const data = await response.json();
      console.log("SendChoice response:", data);
      // –ú–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å UI –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ—Ç–≤–µ—Ç–∞, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤—ã–±–æ—Ä–∞:", error);
      document.getElementById("result").textContent = "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ!";
    }
  }

  // üîÅ –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ –æ–ø—Ä–æ—Å–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
  async function pollUpdates() {
    try {
      const response = await fetch(`/room/${roomID}/update/`);
      if (!response.ok) {
        console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:", response.status);
        return;
      }
      const data = await response.json();
      console.log("–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:", data);
      updateTimer(data['time'])
      // üîÑ –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å UI –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö:
      // –ù–∞–ø—Ä–∏–º–µ—Ä: –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –±–∞–Ω–æ–≤, —Å–º–µ–Ω–∏—Ç—å —Ñ–∞–∑—É, –æ–±–Ω–æ–≤–∏—Ç—å —Ç–∞–π–º–µ—Ä –∏ —Ç.–¥.
      // –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º ‚Äî –≤—ã –º–æ–∂–µ—Ç–µ —Ä–∞—Å—à–∏—Ä–∏—Ç—å –ø–æ–∑–∂–µ.

    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–ø—Ä–æ—Å–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π:", error);
    }
  }

  // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–ø—Ä–æ—Å –∫–∞–∂–¥—ã–µ 1500 –º—Å (1.5 —Å–µ–∫—É–Ω–¥—ã)
  const updateInterval = setInterval(pollUpdates, 1000);

  // –¢–∞–π–º–µ—Ä –≤—ã–±–æ—Ä–∞ —á–µ–º–ø–∏–æ–Ω–∞
  function updateTimer(seconds) {
  const timerElement = document.getElementById("timer");
  
  if (seconds <= 0) {
    timerElement.textContent = "–í—Ä–µ–º—è –≤—ã—à–ª–æ!";
    timerElement.classList.add("time-expired");
  } else {
    const word = seconds === 1 ? "—Å–µ–∫—É–Ω–¥–∞" : (seconds < 5 ? "—Å–µ–∫—É–Ω–¥—ã" : "—Å–µ–∫—É–Ω–¥");
    timerElement.textContent = `–í—Ä–µ–º—è: ${seconds} ${word}`;
    timerElement.classList.remove("time-expired");
  }
}

  timerInterval = setInterval(updateTimer, 1000);

  // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞
  document.getElementById("confirm-btn").addEventListener("click", () => {
    const resultDiv = document.getElementById("result");
    if (selectedCell) {
      resultDiv.textContent = `–í—ã–±—Ä–∞–Ω —á–µ–º–ø–∏–æ–Ω: ${selectedCell.textContent}`;
      SendChoice(selectedCell.textContent);
      clearInterval(timerInterval); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞
    } else {
      resultDiv.textContent = "–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —á–µ–º–ø–∏–æ–Ω–∞!";
    }
  });

  // ‚ùå –£–¥–∞–ª—è–µ–º –≤—ã–∑–æ–≤ loop(), —Ç–∞–∫ –∫–∞–∫ –µ–≥–æ –Ω–µ—Ç
  // loop(); ‚Üê —ç—Ç–∞ —Å—Ç—Ä–æ–∫–∞ –≤—ã–∑—ã–≤–∞–ª–∞ –æ—à–∏–±–∫—É ReferenceError!
</script>
</body>
</html>

