<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–í—ã–±–æ—Ä —á–µ–º–ø–∏–æ–Ω–∞</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background-color: #f5f5f5;
      margin: 0;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 20px;
    }

    #timer-container {
      text-align: center;
      margin-bottom: 10px;
    }

    #timer {
      font-size: 24px;
      font-weight: bold;
      color: #d32f2f;
      padding: 10px;
      background-color: #ffebee;
      border-radius: 8px;
      display: inline-block;
    }

    #current-turn {
      text-align: center;
      font-size: 16px;
      color: #333;
      margin-bottom: 20px;
      font-weight: bold;
    }

    .teams-container {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      gap: 20px;
    }

    .team-column {
      flex: 1;
      min-width: 200px;
    }

    .team-title {
      font-weight: bold;
      margin-bottom: 10px;
      text-align: center;
      color: #333;
    }

    .blue-team .team-title {
      color: #1976d2;
    }

    .red-team .team-title {
      color: #d32f2f;
    }

    .bans-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      margin-bottom: 15px;
    }

    .ban-cell {
      width: 60px;
      height: 60px;
      border: 2px solid #ccc;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #f9f9f9;
      font-weight: bold;
      font-size: 12px;
      text-align: center;
      padding: 5px;
    }

    .blue-team .ban-cell {
      border-color: #1976d2;
      background-color: #e3f2fd;
    }

    .red-team .ban-cell {
      border-color: #d32f2f;
      background-color: #ffebee;
    }

    .main-game-area {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 20px;
      margin-bottom: 20px;
    }

    .picks-column {
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-width: 100px;
    }

    .pick-cell {
      width: 80px;
      height: 80px;
      border: 2px solid #ccc;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #f9f9f9;
      font-weight: bold;
      font-size: 12px;
      text-align: center;
      padding: 5px;
    }

    .blue-picks-column .pick-cell {
      border-color: #1976d2;
      background-color: #e3f2fd;
    }

    .red-picks-column .pick-cell {
      border-color: #d32f2f;
      background-color: #ffebee;
    }

    #champions-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      flex: 1;
      min-width: 400px;
    }

    .champion-cell {
      width: 80px;
      height: 80px;
      border: 2px solid #ccc;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #f9f9f9;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.2s;
      font-size: 12px;
      text-align: center;
      padding: 5px;
    }

    .champion-cell.selected {
      border-color: #007bff;
      background-color: #e7f3ff;
      transform: scale(1.05);
    }

    .buttons-container {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-bottom: 20px;
    }

    .btn {
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    #confirm-btn {
      background-color: #007bff;
      color: white;
    }

    #confirm-btn:hover {
      background-color: #0056b3;
    }

    #ban-btn {
      background-color: #dc3545;
      color: white;
    }

    #ban-btn:hover {
      background-color: #c82333;
    }

    #result {
      margin-top: 15px;
      font-size: 18px;
      font-weight: bold;
      color: #333;
      text-align: center;
      min-height: 24px;
    }

    .time-expired {
      background-color: #ffcdd2 !important;
      color: #b71c1c !important;
    }

    .your-turn {
      color: #2e7d32;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>–í—ã–±–µ—Ä–∏—Ç–µ —á–µ–º–ø–∏–æ–Ω–∞</h1>
    
    <div id="timer-container">
      <div id="timer">–í—Ä–µ–º—è: 30 —Å–µ–∫—É–Ω–¥</div>
    </div>
    
    <div id="current-turn">–¢–µ–∫—É—â–∏–π —Ö–æ–¥: –æ–∂–∏–¥–∞–Ω–∏–µ...</div>
    
    <div class="teams-container">
      <div class="team-column blue-team">
        <div class="team-title">–°–∏–Ω–∏–µ</div>
        <div class="bans-list" id="blue-bans"></div>
      </div>
      
      <div class="team-column red-team">
        <div class="team-title">–ö—Ä–∞—Å–Ω—ã–µ</div>
        <div class="bans-list" id="red-bans"></div>
      </div>
    </div>

    <div class="main-game-area">
      <div class="picks-column blue-picks-column" id="blue-picks"></div>
      
      <div id="champions-container">
        <!-- –Ø—á–µ–π–∫–∏ –±—É–¥—É—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã —Å—é–¥–∞ -->
      </div>
      
      <div class="picks-column red-picks-column" id="red-picks"></div>
    </div>

    <div class="buttons-container">
      <button id="confirm-btn" class="btn">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
    </div>
    
    <div id="result"></div>
  </div>

  <script>
  const champions = ["–ê—Ä–∏", "–ë—Ä–∞—É–º", "–í–∏–∫—Ç–æ—Ä", "–ì–∞–ª–∏–æ", "–î–∞—Ä–∏—É—Å", "–Å–Ω–µ", "–ñ–∞–Ω–Ω–∞", "–≠–ª–∏–∑–∞", "–ö—Å–∏–Ω", "–û—Ä–∏–∞–Ω–Ω–∞"];
  const roomID = window.location.pathname.split('/')[2];
  const container = document.getElementById("champions-container");
  const timerElement = document.getElementById("timer");
  const currentTurnElement = document.getElementById("current-turn");
  const blueBansElement = document.getElementById("blue-bans");
  const redBansElement = document.getElementById("red-bans");
  const bluePicksElement = document.getElementById("blue-picks");
  const redPicksElement = document.getElementById("red-picks");
  let selectedCell = null;
  let timeLeft = 30;
  let timerInterval = null;
  let currentTurn = null;
  let gameStatus = null;

  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —è—á–µ–µ–∫ —á–µ–º–ø–∏–æ–Ω–æ–≤
  champions.forEach(name => {
    const cell = document.createElement("div");
    cell.classList.add("champion-cell");
    cell.textContent = name;
    cell.addEventListener("click", () => {
      if (selectedCell) selectedCell.classList.remove("selected");
      cell.classList.add("selected");
      selectedCell = cell;
    });
    container.appendChild(cell);
  });

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  async function SendChoice(champName) {
    try {
      const userUID = localStorage.getItem('user_uid');
      if (!userUID) {
        document.getElementById("result").textContent = "–û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω!";
        return;
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –¥–æ–ª–∂–µ–Ω –¥–µ–ª–∞—Ç—å —Ö–æ–¥
      if (currentTurn !== userUID) {
        document.getElementById("result").textContent = "–ù–µ –≤–∞—à —Ö–æ–¥!";
        return;
      }

      const response = await fetch(`/room/${roomID}/action/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ 
          user_uid: userUID, 
          champName: champName 
        })
      });
      const data = await response.json();
      console.log("SendChoice response:", data);
      // –ú–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å UI –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ—Ç–≤–µ—Ç–∞, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤—ã–±–æ—Ä–∞:", error);
      document.getElementById("result").textContent = "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ!";
    }
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –±–∞–Ω–æ–≤ (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ)
  function renderBans(bansList, containerElement) {
    containerElement.innerHTML = '';
    if (bansList && bansList.length > 0) {
      bansList.forEach(ban => {
        const banCell = document.createElement("div");
        banCell.classList.add("ban-cell");
        banCell.textContent = ban;
        containerElement.appendChild(banCell);
      });
    }
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–∏–∫–æ–≤ (–≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ –ø–æ –∫—Ä–∞—è–º)
  function renderPicks(picksList, containerElement) {
    containerElement.innerHTML = '';
    if (picksList && picksList.length > 0) {
      picksList.forEach(pick => {
        const pickCell = document.createElement("div");
        pickCell.classList.add("pick-cell");
        pickCell.textContent = pick;
        containerElement.appendChild(pickCell);
      });
    }
  }

  // üîÅ –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ –æ–ø—Ä–æ—Å–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
  let updateInterval; // –û–±—ä—è–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –î–û –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

  async function pollUpdates() {
    try {
      const response = await fetch(`/room/${roomID}/update/`);
      if (!response.ok) {
        let savedI = localStorage.getItem('i');
        console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:", response.status);
        
        if (i > 5) { clearInterval(updateInterval); localStorage.setItem('i', 0);}
        i++;
        localStorage.setItem('i', i);
        return;
      }
      const data = await response.json();
      console.log("–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:", data);

      // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–π–º–µ—Ä
      updateTimer(data.time);

      // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —Ö–æ–¥
      currentTurn = data.cur_Turn;
      gameStatus = data.status;
      const userUID = localStorage.getItem('user_uid');
      if (currentTurn === userUID) {
        currentTurnElement.textContent = "–í–∞—à —Ö–æ–¥!";
        currentTurnElement.className = "your-turn";
      } else {
        currentTurnElement.textContent = `–•–æ–¥ –∏–≥—Ä–æ–∫–∞: ${currentTurn || '–æ–∂–∏–¥–∞–Ω–∏–µ...'}`;
        currentTurnElement.className = "";
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–Ω—ã –∏ –ø–∏–∫–∏
      renderBans(data.blue_bans, blueBansElement);
      renderBans(data.red_bans, redBansElement);
      renderPicks(data.blue_piks, bluePicksElement);
      renderPicks(data.red_picks, redPicksElement);

      // –ï—Å–ª–∏ –∏–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ ‚Äî –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–ø—Ä–æ—Å
      if (gameStatus == 'end') {
        clearInterval(updateInterval); // –¢–µ–ø–µ—Ä—å updateInterval –¥–æ—Å—Ç—É–ø–µ–Ω
      }
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–ø—Ä–æ—Å–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π:", error);
      clearInterval(updateInterval);
    }
  }

  // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–ø—Ä–æ—Å –∫–∞–∂–¥—ã–µ 500 –º—Å
  updateInterval = setInterval(pollUpdates, 500);

  // –¢–∞–π–º–µ—Ä –≤—ã–±–æ—Ä–∞ —á–µ–º–ø–∏–æ–Ω–∞
  function updateTimer(seconds) {
    if (seconds <= 0) {
      timerElement.textContent = "–í—Ä–µ–º—è –≤—ã—à–ª–æ!";
      timerElement.classList.add("time-expired");
    } else {
      const word = seconds === 1 ? "—Å–µ–∫—É–Ω–¥–∞" : (seconds < 5 ? "—Å–µ–∫—É–Ω–¥—ã" : "—Å–µ–∫—É–Ω–¥");
      timerElement.textContent = `–í—Ä–µ–º—è: ${seconds} ${word}`;
      timerElement.classList.remove("time-expired");
    }
  }

  // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞
  document.getElementById("confirm-btn").addEventListener("click", () => {
    const resultDiv = document.getElementById("result");
    const userUID = localStorage.getItem('user_uid');
    
    if (!userUID) {
      resultDiv.textContent = "–û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω!";
      return;
    }
    
    if (selectedCell) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –¥–µ–ª–∞—Ç—å —Ö–æ–¥
      if (currentTurn !== userUID) {
        resultDiv.textContent = "–ù–µ –≤–∞—à —Ö–æ–¥!";
        return;
      }
      
      resultDiv.textContent = `–í—ã–±—Ä–∞–Ω —á–µ–º–ø–∏–æ–Ω: ${selectedCell.textContent}`;
      SendChoice(selectedCell.textContent);
      // –ù–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä, —Ç–∞–∫ –∫–∞–∫ –æ–Ω —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å–µ—Ä–≤–µ—Ä–æ–º
    } else {
      resultDiv.textContent = "–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —á–µ–º–ø–∏–æ–Ω–∞!";
    }
  });
  </script>
</body>
</html>

